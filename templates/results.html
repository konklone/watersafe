<!DOCTYPE html>
<html>
	<head>
		<title> H2OSafe </title>
		<link rel="stylesheet" type="text/css" href="/static/css/style.css" />
		<link rel="stylesheet" type="text/css" href="/static/css/cardstyle.css" />
		<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.css" />
		<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
		<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
		<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
		<script type="text/javascript" src="http://www.google.com/jsapi"></script>		
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAgOtSDfC2YlXdjoZvP5Goi6TpQRFZV2sw&sensor=false"></script>
		<script src="/static/js/bootstrap.js"></script>
		<script type="text/javascript">
			var geocoder;
			var map;

			function codeAddress() {
				geocoder = new google.maps.Geocoder();
				var address = document.getElementById("reqAddress").value;
				var mapOptions = {
					zoom : 11,
					mapTypeId : google.maps.MapTypeId.ROADMAP
				}
				map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
				
				geocoder.geocode({
					'address' : address
				}, function(results, status) {
					if (status == google.maps.GeocoderStatus.OK) {
						map.setCenter(results[0].geometry.location);
						var marker = new google.maps.Marker({
							map : map,
							position : results[0].geometry.location
						});
					} else {
						alert("Geocode was not successful for the following reason: " + status);
					}
				});
			}
			
			function getPopTitle(target) {
    			return target;
			};
		
			function getPopContent(target) {
				console.log(" target is" + target);
				var res = $("div[id='"+target+"']").html();
    			return res;
			}

			google.load('visualization', '1', {
				packages : ['motionchart']
			});

			function drawVisualization() {
				var countyId = document.getElementById("countyId").value;
				console.log($("countyId").html());
				var jsonData = $.ajax({
					data : {
							'countyId' : countyId,
						}, // get the form data
					type : 'post', // GET or POST
					url : "/motionChart",
					dataType : "json",
					async : false
				}).responseText;
				// Create our data table out of JSON data loaded from server.
				var data = new google.visualization.DataTable(jsonData);

				var motionchart = new google.visualization.MotionChart(document.getElementById('visualization'));

				var options = {};
				options['state'] = '{"yZoomedIn":false,"iconType":"BUBBLE","yZoomedDataMax":107,"time":"1992","yAxisOption":"2","orderedByY":false,"uniColorForNonSelected":false,"sizeOption":"2","playDuration":15000,"yLambda":1,"dimensions":{"iconDimensions":["dim0"]},"xZoomedDataMin":0,"showTrails":true,"nonSelectedAlpha":0.4,"iconKeySettings":[],"yZoomedDataMin":1,"xAxisOption":"_ALPHABETICAL","duration":{"multiplier":1,"timeUnit":"Y"},"orderedByX":false,"xZoomedIn":false,"xZoomedDataMax":67,"colorOption":"2","xLambda":1}';
				options['width'] = 800;
				options['height'] = 400;
				options['showSelectListComponent'] = false;
				options['showChartButtons'] = false;
				options['showXMetricPicker'] = false;
				options['showYMetricPicker'] = false;
				//options['showXScalePicker'] = false;
				//options['showYScalePicker'] = false;
				options['showAdvancedPanel'] = false;
				
				motionchart.draw(data, options);
			}
			google.setOnLoadCallback(drawVisualization);

			$(document).ready(function() {
				
				$(".chemical").each(function() {

				 var $pElem= $(this);
				 console.log($pElem.text());
				$pElem.popover(
    			{
      				title: getPopTitle($pElem.text()),
      				content: getPopContent($pElem.text()),
      				trigger: "hover",
					placement: "auto"
    			}
				);
			});

				
				
				$("#dialog").dialog({
					autoOpen : false
				});
				$("#emailText").hide();

				$('.tell-others').click(function() {
					console.log('hello')
					$('.social').slideToggle(300);
				});


				$('#greenBtn').click(function() {
					$("#dialog").dialog("open");
					return false;
				});

				$('#emailNotify').click(function() {
					if ($('#emailNotify').is(':checked')) {
						$("#emailText").show();
					} else {
						$("#emailText").hide();
					}
				});

				$('#emailBtn').click(function() {
					$("#dialog").dialog("close");
					var address = document.getElementById("reqAddress").value;
					var userEmail = document.getElementById("emailText").value;
					alert(userEmail);
					var reportTo = document.getElementById("reportTo").innerHtml;
					$.ajax({// create an AJAX call...
						data : {
							'reqAddress' : address,
							'emailText' : userEmail,
							'reportTo' : reportTo
						}, // get the form data
						type : 'post', // GET or POST
						url : '/sendEmail', // the file to call

						success : function(response) {// on success..
							alert('Email Sent');

						}
					});
					return false;
				});
			});
		</script>
	</head>
	<body onload="codeAddress()">
		<form id="form1" action="/results" method="post">
			<input type="hidden" id="countyId" name="countyId" value='{{county_id}}' />
			<div class="container">
				<div class="map-view left">
					<div class="map-box" id="map-canvas">
					</div>

					<br />

					<div class="search-on-results">
						<form action="/results" method="post">
							{% csrf_token %}
							<input type="text" name="address" id="address" placeholder="Type in your address..."/>
							<input type="submit" class="hows-the-water" value="How's My Water?" />
						</form>
					</div>
				</div>

				<div class="detail-view right">

					<div class=" {{ rating_type }} rating">
						<h1> {% if bucket == "G" %}
						GREAT!
						{% elif bucket == "Y" %}
						WARNING!
						{% else %}
						NEEDS ACTION!
						{% endif %} </h1>
						<hr />

						<p>
							<br />
							{% if bucket == "G" %}
							Your water is in great shape.
							{% elif bucket == "Y" %}
							Warning: Your water is alright but could be better.
							{% else %}
							Contact your state rep right away, you should not be drinking this water at all.
							{% endif %}
						</p>

						<br />
						<div class="sharing" style="display: none">
							<div>
								<button class="green-button" id="greenBtn">
									{% if bucket == "G" %}
									Thank Your Rep
									{% else %}
									Contact Rep
									{% endif %}
								</button>
								<button class="green-button tell-others">
									Tell Others to Check
								</button>
							</div>

							<div id="dialog" title="Send Email">
								<b> Report To </b><label id="reportTo">{{ email_id }}</label>
								<br>
								<input type="text" id="emailText" name="emailText" placeholder="your email address..."/>
								<input type="checkbox" id="emailNotify"/>
								Notify Me

								<div contenteditable="false" id="emailDiv">
									{{ email_content }}
								</div>
								<input type="hidden" id="reqAddress" name="reqAddress" value='{{req_address}}' />
								<input type="submit" id="emailBtn" class="css3button" value="Send Email"/>
							</div>

						</div>

						<div class="social" style="display:none;" >
							<!-- AddThis Button BEGIN -->
							<div class="addthis_toolbox addthis_default_style ">
								<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
								<a class="addthis_button_tweet"></a>
							</div>
							<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=xa-51aa48f2699c65f9"></script>
							<!-- AddThis Button END -->
						</div>

						<br class="clear-right" />
					</div>

					<div id="total">
						<h2>{{ incident_count }} Total Violations</h2>
						<br />
					</div>
					<div class="container">
						<ul class="nav nav-tabs">
							<li class="active">
								<a href="#violations" data-toggle="tab">Violations</a>
							</li>
							<li class>
								<a href="#historical" data-toggle="tab">Historical trend</a>
							</li>
						</ul>
						<div class="tab-content">
							<div id="historical" class="tab-pane fade in" style="width: 1019px; padding-left: 0px; ">
								<h4> Click play button to see a historical trend of contamination violation in your state </h4>
								<div id="visualization" style="width: 800px; height: 400px;"></div>
								<h6> Click on a bubble (county) to trace its history</h6>
							</div>
							<div id="violations" class="tab-pane fade in active" style="width: 600px; padding-left: 0px; ">
								<div id="wrapper">
									<div id="columns">
										{% for item in pws_info %}
										<div class="pin" id = "pin">
											<div class="details">
												<div class="item">
													<div class="top"> <span class="badge pull-right">{{item.CONTAMINATION_CNT}}</span>
														<div class="name left">
															<p style="font-weight:bold; font-size:14px;">
																{{ item.pws_name }}
															</p>
														</div>

														<div class="active-type right">
															<p class="active">
																{{item.pws_status}}
															</p>
														</div>

														<br class="clear-both" />
													</div>

													<div class="wrapper">
														<p>
															City: <span class="city">{{item.contact_city}}</span>
														</p>
														<p>
															Population Served: <span class="served">{{item.population_served}}</span>
														</p>

														<div class="violations red-rating">
															<p>
																Violation: <span class="type">{{ item.violation_name }}</span>
															</p>
															<p>
																Contaminant: <div id="contaminant{{forloop.counter}}" class="chemical" ><span >{{ item.contaminant }}</span></div>
																<div id="{{ item.contaminant }}" style="display: none" >  {{ item.health_effect }}</div>
															</p>
														</div>
													</div>
												</div>
											</div>
										</div>
										{% endfor %}
										<br style="clear:both;" />
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<br class="clear-both" />
		</form>
	</body>
</html>
